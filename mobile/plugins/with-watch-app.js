/**
 * Expo Config Plugin: with-watch-app
 *
 * Injects a watchOS app target into the Xcode project during `expo prebuild`.
 * Since @bacons/apple-targets does not support watchOS, this plugin manually
 * adds all necessary PBX objects to project.pbxproj.
 *
 * The plugin is idempotent — it skips if the target already exists.
 */
const { withXcodeProject, withEntitlementsPlist } = require('@expo/config-plugins');

const WATCH_TARGET_NAME = 'KinevoWatch';
const WATCH_BUNDLE_ID = 'com.kinevo.mobile.watchkitapp';
const WATCH_DEPLOYMENT_TARGET = '10.0';
const COMPANION_BUNDLE_ID = 'com.kinevo.mobile';

// Known UUIDs from the existing project
const MAIN_TARGET_UUID = '13B07F861A680F5B00A75B9A';
const PROJECT_UUID = '83CBB9F71A601CBA00E9B192';
const MAIN_GROUP_UUID = '83CBB9F61A601CBA00E9B192';
const PRODUCTS_GROUP_UUID = '83CBBA001A601CBA00E9B192';
// expo:targets group UUID is dynamic (generated by @bacons/apple-targets) — found by name at runtime

function withWatchApp(config) {
  // 1. Modify the Xcode project
  config = withXcodeProject(config, (config) => {
    const proj = config.modResults;
    const objects = proj.hash.project.objects;

    // --- Idempotency check ---
    const nativeTargets = objects['PBXNativeTarget'] || {};
    for (const key of Object.keys(nativeTargets)) {
      if (typeof nativeTargets[key] === 'object' && nativeTargets[key].name === WATCH_TARGET_NAME) {
        console.log(`[with-watch-app] Target "${WATCH_TARGET_NAME}" already exists, skipping.`);
        return config;
      }
    }

    console.log(`[with-watch-app] Adding watchOS target "${WATCH_TARGET_NAME}"...`);

    const gen = () => proj.generateUuid();

    // Generate all needed UUIDs upfront
    const uuids = {
      productRef: gen(),
      fileGroup: gen(),
      exceptionSet: gen(),
      sourcesPhase: gen(),
      frameworksPhase: gen(),
      resourcesPhase: gen(),
      debugConfig: gen(),
      releaseConfig: gen(),
      configList: gen(),
      target: gen(),
      containerProxy: gen(),
      targetDep: gen(),
      embedPhase: gen(),
      embedBuildFile: gen(),
    };

    // --- 1. PBXFileReference for the product ---
    objects['PBXFileReference'][uuids.productRef] = {
      isa: 'PBXFileReference',
      explicitFileType: '"wrapper.application"',
      includeInIndex: 0,
      path: `${WATCH_TARGET_NAME}.app`,
      sourceTree: 'BUILT_PRODUCTS_DIR',
    };
    objects['PBXFileReference'][`${uuids.productRef}_comment`] = `${WATCH_TARGET_NAME}.app`;

    // --- 2. PBXFileSystemSynchronizedRootGroup ---
    if (!objects['PBXFileSystemSynchronizedRootGroup']) {
      objects['PBXFileSystemSynchronizedRootGroup'] = {};
    }
    objects['PBXFileSystemSynchronizedRootGroup'][uuids.fileGroup] = {
      isa: 'PBXFileSystemSynchronizedRootGroup',
      exceptions: [
        { value: uuids.exceptionSet, comment: `Exceptions for "watch-app" folder in "${WATCH_TARGET_NAME}" target` },
      ],
      explicitFileTypes: {},
      explicitFolders: [],
      path: '"../targets/watch-app"',
      sourceTree: '"<group>"',
    };
    objects['PBXFileSystemSynchronizedRootGroup'][`${uuids.fileGroup}_comment`] = 'watch-app';

    // --- 3. PBXFileSystemSynchronizedBuildFileExceptionSet ---
    if (!objects['PBXFileSystemSynchronizedBuildFileExceptionSet']) {
      objects['PBXFileSystemSynchronizedBuildFileExceptionSet'] = {};
    }
    objects['PBXFileSystemSynchronizedBuildFileExceptionSet'][uuids.exceptionSet] = {
      isa: 'PBXFileSystemSynchronizedBuildFileExceptionSet',
      membershipExceptions: ['Info.plist'],
      target: uuids.target,
    };
    objects['PBXFileSystemSynchronizedBuildFileExceptionSet'][`${uuids.exceptionSet}_comment`] =
      `Exceptions for "watch-app" folder in "${WATCH_TARGET_NAME}" target`;

    // --- 4. Build Phases ---
    objects['PBXSourcesBuildPhase'][uuids.sourcesPhase] = {
      isa: 'PBXSourcesBuildPhase',
      buildActionMask: 2147483647,
      files: [],
      runOnlyForDeploymentPostprocessing: 0,
    };
    objects['PBXSourcesBuildPhase'][`${uuids.sourcesPhase}_comment`] = 'Sources';

    objects['PBXFrameworksBuildPhase'][uuids.frameworksPhase] = {
      isa: 'PBXFrameworksBuildPhase',
      buildActionMask: 2147483647,
      files: [],
      runOnlyForDeploymentPostprocessing: 0,
    };
    objects['PBXFrameworksBuildPhase'][`${uuids.frameworksPhase}_comment`] = 'Frameworks';

    objects['PBXResourcesBuildPhase'][uuids.resourcesPhase] = {
      isa: 'PBXResourcesBuildPhase',
      buildActionMask: 2147483647,
      files: [],
      runOnlyForDeploymentPostprocessing: 0,
    };
    objects['PBXResourcesBuildPhase'][`${uuids.resourcesPhase}_comment`] = 'Resources';

    // --- 5. Build Configurations ---
    const sharedSettings = {
      ASSETCATALOG_COMPILER_APPICON_NAME: 'AppIcon',
      CODE_SIGN_ENTITLEMENTS: '"../targets/watch-app/KinevoWatch.entitlements"',
      CODE_SIGN_STYLE: 'Automatic',
      CURRENT_PROJECT_VERSION: 1,
      GENERATE_INFOPLIST_FILE: 'YES',
      INFOPLIST_FILE: '"../targets/watch-app/Info.plist"',
      INFOPLIST_KEY_CFBundleDisplayName: '"Kinevo"',
      INFOPLIST_KEY_WKCompanionAppBundleIdentifier: `"${COMPANION_BUNDLE_ID}"`,
      PRODUCT_BUNDLE_IDENTIFIER: `"${WATCH_BUNDLE_ID}"`,
      PRODUCT_NAME: '"$(TARGET_NAME)"',
      SDKROOT: 'watchos',
      SKIP_INSTALL: 'YES',
      SWIFT_EMIT_LOC_STRINGS: 'YES',
      SWIFT_VERSION: '5.0',
      TARGETED_DEVICE_FAMILY: 4,
      WATCHOS_DEPLOYMENT_TARGET: `"${WATCH_DEPLOYMENT_TARGET}"`,
    };

    objects['XCBuildConfiguration'][uuids.debugConfig] = {
      isa: 'XCBuildConfiguration',
      buildSettings: {
        ...sharedSettings,
        DEBUG_INFORMATION_FORMAT: 'dwarf',
        SWIFT_ACTIVE_COMPILATION_CONDITIONS: '"$(inherited) DEBUG"',
        SWIFT_OPTIMIZATION_LEVEL: '"-Onone"',
      },
      name: 'Debug',
    };
    objects['XCBuildConfiguration'][`${uuids.debugConfig}_comment`] = 'Debug';

    objects['XCBuildConfiguration'][uuids.releaseConfig] = {
      isa: 'XCBuildConfiguration',
      buildSettings: {
        ...sharedSettings,
        COPY_PHASE_STRIP: 'NO',
        SWIFT_COMPILATION_MODE: 'wholemodule',
        SWIFT_OPTIMIZATION_LEVEL: '"-O"',
      },
      name: 'Release',
    };
    objects['XCBuildConfiguration'][`${uuids.releaseConfig}_comment`] = 'Release';

    // --- 6. XCConfigurationList ---
    objects['XCConfigurationList'][uuids.configList] = {
      isa: 'XCConfigurationList',
      buildConfigurations: [
        { value: uuids.debugConfig, comment: 'Debug' },
        { value: uuids.releaseConfig, comment: 'Release' },
      ],
      defaultConfigurationIsVisible: 0,
      defaultConfigurationName: 'Release',
    };
    objects['XCConfigurationList'][`${uuids.configList}_comment`] =
      `Build configuration list for PBXNativeTarget "${WATCH_TARGET_NAME}"`;

    // --- 7. PBXNativeTarget ---
    objects['PBXNativeTarget'][uuids.target] = {
      isa: 'PBXNativeTarget',
      buildConfigurationList: uuids.configList,
      buildPhases: [
        { value: uuids.sourcesPhase, comment: 'Sources' },
        { value: uuids.frameworksPhase, comment: 'Frameworks' },
        { value: uuids.resourcesPhase, comment: 'Resources' },
      ],
      buildRules: [],
      dependencies: [],
      fileSystemSynchronizedGroups: [uuids.fileGroup],
      name: `"${WATCH_TARGET_NAME}"`,
      productName: `"${WATCH_TARGET_NAME}"`,
      productReference: uuids.productRef,
      productType: '"com.apple.product-type.application"',
    };
    objects['PBXNativeTarget'][`${uuids.target}_comment`] = WATCH_TARGET_NAME;

    // --- 8. Add to PBXProject targets array ---
    const projectObj = objects['PBXProject'][PROJECT_UUID];
    if (projectObj && projectObj.targets) {
      projectObj.targets.push({ value: uuids.target, comment: WATCH_TARGET_NAME });
    }

    // Add target attributes
    if (projectObj && projectObj.attributes && projectObj.attributes.TargetAttributes) {
      projectObj.attributes.TargetAttributes[uuids.target] = {
        CreatedOnToolsVersion: '15.0',
        ProvisioningStyle: 'Automatic',
      };
    }

    // --- 9. PBXContainerItemProxy + PBXTargetDependency ---
    if (!objects['PBXContainerItemProxy']) {
      objects['PBXContainerItemProxy'] = {};
    }
    if (!objects['PBXTargetDependency']) {
      objects['PBXTargetDependency'] = {};
    }
    objects['PBXContainerItemProxy'][uuids.containerProxy] = {
      isa: 'PBXContainerItemProxy',
      containerPortal: PROJECT_UUID,
      proxyType: 1,
      remoteGlobalIDString: uuids.target,
      remoteInfo: `"${WATCH_TARGET_NAME}"`,
    };
    objects['PBXContainerItemProxy'][`${uuids.containerProxy}_comment`] = 'PBXContainerItemProxy';

    objects['PBXTargetDependency'][uuids.targetDep] = {
      isa: 'PBXTargetDependency',
      target: uuids.target,
      targetProxy: uuids.containerProxy,
    };
    objects['PBXTargetDependency'][`${uuids.targetDep}_comment`] = 'PBXTargetDependency';

    // Add dependency to main Kinevo target
    const mainTarget = objects['PBXNativeTarget'][MAIN_TARGET_UUID];
    if (mainTarget && mainTarget.dependencies) {
      mainTarget.dependencies.push({ value: uuids.targetDep, comment: 'PBXTargetDependency' });
    }

    // --- 10. Embed Watch Content (PBXCopyFilesBuildPhase) ---
    if (!objects['PBXBuildFile']) {
      objects['PBXBuildFile'] = {};
    }
    if (!objects['PBXCopyFilesBuildPhase']) {
      objects['PBXCopyFilesBuildPhase'] = {};
    }
    objects['PBXBuildFile'][uuids.embedBuildFile] = {
      isa: 'PBXBuildFile',
      fileRef: uuids.productRef,
      settings: { ATTRIBUTES: ['RemoveHeadersOnCopy'] },
    };
    objects['PBXBuildFile'][`${uuids.embedBuildFile}_comment`] = `${WATCH_TARGET_NAME}.app in Embed Watch Content`;

    objects['PBXCopyFilesBuildPhase'][uuids.embedPhase] = {
      isa: 'PBXCopyFilesBuildPhase',
      buildActionMask: 2147483647,
      dstPath: '""',
      dstSubfolderSpec: 16, // Watch content
      files: [
        { value: uuids.embedBuildFile, comment: `${WATCH_TARGET_NAME}.app in Embed Watch Content` },
      ],
      name: '"Embed Watch Content"',
      runOnlyForDeploymentPostprocessing: 0,
    };
    objects['PBXCopyFilesBuildPhase'][`${uuids.embedPhase}_comment`] = 'Embed Watch Content';

    // Add embed phase to main target's build phases
    if (mainTarget && mainTarget.buildPhases) {
      mainTarget.buildPhases.push({ value: uuids.embedPhase, comment: 'Embed Watch Content' });
    }

    // --- 11. Add product to Products group ---
    const productsGroup = objects['PBXGroup'][PRODUCTS_GROUP_UUID];
    if (productsGroup && productsGroup.children) {
      productsGroup.children.push({ value: uuids.productRef, comment: `${WATCH_TARGET_NAME}.app` });
    }

    // --- 12. Add file group to main project group ---
    // Note: expo:targets group is created by @bacons/apple-targets which runs after this plugin.
    // We add directly to the main group with full relative path from ios/.
    const mainGroup = objects['PBXGroup'][MAIN_GROUP_UUID];
    if (mainGroup && mainGroup.children) {
      mainGroup.children.push({ value: uuids.fileGroup, comment: 'watch-app' });
    }

    console.log(`[with-watch-app] Successfully added watchOS target "${WATCH_TARGET_NAME}" (UUID: ${uuids.target})`);

    return config;
  });

  // 2. Add HealthKit to iOS entitlements
  config = withEntitlementsPlist(config, (config) => {
    config.modResults['com.apple.developer.healthkit'] = true;
    config.modResults['com.apple.developer.healthkit.access'] = [];
    return config;
  });

  return config;
}

module.exports = withWatchApp;
